{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/lib/auth-constants.ts"],"sourcesContent":["export const COOKIE_NAME = \"admin_session\";\n"],"names":[],"mappings":";;;;AAAO,MAAM,cAAc"}},
    {"offset": {"line": 25, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/middleware.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { COOKIE_NAME } from \"@/lib/auth-constants\";\n\n/** Encode ArrayBuffer to base64url (Edge-safe). */\nfunction arrayBufferToBase64url(buffer: ArrayBuffer): string {\n  const bytes = new Uint8Array(buffer);\n  let binary = \"\";\n  for (let i = 0; i < bytes.length; i++) {\n    binary += String.fromCharCode(bytes[i]);\n  }\n  return btoa(binary).replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=+$/, \"\");\n}\n\nasync function verifySession(cookieValue: string, secret: string): Promise<boolean> {\n  const dot = cookieValue.indexOf(\".\");\n  if (dot === -1) return false;\n  const expiryStr = cookieValue.slice(0, dot);\n  const signatureB64 = cookieValue.slice(dot + 1);\n  const expiry = Number(expiryStr);\n  if (!Number.isFinite(expiry) || expiry <= Date.now()) return false;\n\n  const key = await crypto.subtle.importKey(\n    \"raw\",\n    new TextEncoder().encode(secret),\n    { name: \"HMAC\", hash: \"SHA-256\" },\n    false,\n    [\"sign\"]\n  );\n\n  const sig = await crypto.subtle.sign(\n    \"HMAC\",\n    key,\n    new TextEncoder().encode(expiryStr)\n  );\n\n  const expectedSig = arrayBufferToBase64url(sig);\n  if (expectedSig.length !== signatureB64.length) return false;\n  let same = true;\n  for (let i = 0; i < expectedSig.length; i++) {\n    if (expectedSig[i] !== signatureB64[i]) same = false;\n  }\n  return same;\n}\n\nexport async function middleware(req: NextRequest) {\n  const path = req.nextUrl.pathname;\n\n  // Allow login page and login API\n  if (path === \"/admin/login\" || path === \"/api/auth/login\") {\n    const cookie = req.cookies.get(COOKIE_NAME)?.value;\n    const secret = process.env.SMTP_PASS;\n    if (path === \"/admin/login\" && cookie && secret) {\n      const verified = await verifySession(cookie, secret);\n      if (verified) {\n        return NextResponse.redirect(new URL(\"/admin\", req.url));\n      }\n    }\n    return NextResponse.next();\n  }\n\n  // Protect /admin (except login, already handled)\n  if (path.startsWith(\"/admin\")) {\n    const cookie = req.cookies.get(COOKIE_NAME)?.value;\n    const secret = process.env.SMTP_PASS;\n    if (!secret) {\n      return NextResponse.redirect(new URL(\"/admin/login\", req.url));\n    }\n    if (!cookie) {\n      return NextResponse.redirect(new URL(\"/admin/login\", req.url));\n    }\n    const verified = await verifySession(cookie, secret);\n    if (!verified) {\n      const res = NextResponse.redirect(new URL(\"/admin/login\", req.url));\n      res.cookies.delete(COOKIE_NAME);\n      return res;\n    }\n    return NextResponse.next();\n  }\n\n  // Protect /api/admin\n  if (path.startsWith(\"/api/admin\")) {\n    const cookie = req.cookies.get(COOKIE_NAME)?.value;\n    const secret = process.env.SMTP_PASS;\n    if (!secret || !cookie) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n    const verified = await verifySession(cookie, secret);\n    if (!verified) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n    return NextResponse.next();\n  }\n\n  return NextResponse.next();\n}\n\nexport const config = {\n  matcher: [\"/admin\", \"/admin/((?!login).*)\", \"/api/admin/:path*\", \"/admin/login\", \"/api/auth/login\"],\n};\n"],"names":[],"mappings":"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"}}]
}